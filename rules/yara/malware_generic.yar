/*
 * BludEDR - malware_generic.yar
 * Generic malware detection signatures
 */

rule Suspicious_PE_Header
{
    meta:
        description = "PE file with suspicious characteristics"
        author = "BludEDR"
        severity = "medium"
        score = 40

    condition:
        uint16(0) == 0x5A4D and
        (
            /* Small PE with high entropy (packed) */
            (filesize < 100KB and math.entropy(0, filesize) > 7.0) or
            /* PE with no imports (likely packed/encrypted) */
            (pe.number_of_imports == 0 and filesize > 1KB) or
            /* PE compiled in the future (timestomping) */
            (pe.timestamp > 2000000000)
        )
}

rule Suspicious_Strings_Credential_Access
{
    meta:
        description = "Binary contains credential theft related strings"
        author = "BludEDR"
        severity = "high"
        score = 75

    strings:
        $s1 = "sekurlsa" ascii nocase
        $s2 = "kerberos" ascii nocase
        $s3 = "wdigest" ascii nocase
        $s4 = "lsadump" ascii nocase
        $s5 = "mimikatz" ascii nocase
        $s6 = "gentilkiwi" ascii nocase
        $s7 = "dpapi" ascii nocase
        $s8 = "logonpasswords" ascii nocase
        $s9 = "SAMDump" ascii nocase
        $s10 = "lsass.exe" ascii nocase

    condition:
        3 of them
}

rule Suspicious_Strings_C2
{
    meta:
        description = "Binary contains C2 framework related strings"
        author = "BludEDR"
        severity = "high"
        score = 80

    strings:
        $cobalt1 = "beacon.dll" ascii
        $cobalt2 = "ReflectiveLoader" ascii
        $cobalt3 = "%s.4%08x%08x%08x%08x%08x.%08x%08x%08x%08x%08x%08x%08x.%08x%08x%08x%08x%08x%08x%08x.%08x%08x%08x" ascii
        $cobalt4 = "%%c%%c%%c%%c%%c%%c%%c%%c%%cMSSE-" ascii
        $meta1 = "meterpreter" ascii nocase
        $meta2 = "metasploit" ascii nocase
        $sliver1 = "sliverpb" ascii
        $sliver2 = "implant.Implant" ascii
        $empire1 = "PowerShellEmpire" ascii nocase
        $covenant1 = "Covenant" ascii nocase
        $havoc1 = "HavocFramework" ascii

    condition:
        any of them
}

rule Suspicious_Powershell_Script
{
    meta:
        description = "Suspicious PowerShell script patterns"
        author = "BludEDR"
        severity = "high"
        score = 70

    strings:
        $enc1 = "-EncodedCommand" ascii nocase
        $enc2 = "-enc " ascii nocase
        $enc3 = "FromBase64String" ascii nocase
        $bypass1 = "-ExecutionPolicy Bypass" ascii nocase
        $bypass2 = "-ep bypass" ascii nocase
        $bypass3 = "Set-ExecutionPolicy" ascii nocase
        $download1 = "Net.WebClient" ascii nocase
        $download2 = "DownloadString" ascii nocase
        $download3 = "DownloadFile" ascii nocase
        $download4 = "Invoke-WebRequest" ascii nocase
        $download5 = "wget " ascii nocase
        $download6 = "curl " ascii nocase
        $exec1 = "Invoke-Expression" ascii nocase
        $exec2 = "IEX(" ascii nocase
        $exec3 = "IEX " ascii nocase
        $amsi1 = "AmsiUtils" ascii nocase
        $amsi2 = "amsiInitFailed" ascii nocase
        $amsi3 = "AmsiScanBuffer" ascii nocase
        $refl1 = "Reflection.Assembly" ascii nocase
        $refl2 = "[System.Reflection" ascii nocase

    condition:
        3 of them
}

rule PE_Anomaly_No_Imports
{
    meta:
        description = "PE with no import table (packed or manually resolved)"
        author = "BludEDR"
        severity = "medium"
        score = 50

    condition:
        uint16(0) == 0x5A4D and
        pe.number_of_imports == 0 and
        filesize > 4KB and filesize < 10MB
}
